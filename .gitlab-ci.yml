stages:
  - test
  - secret-detection

# --- SAST (Semgrep) ---
sast:
  stage: test
  image:
    name: registry.gitlab.com/gitlab-org/security-products/analyzers/semgrep:latest
    entrypoint: [""]     # make sure /analyzer is invoked as the main process
  script:
    - /analyzer run
  artifacts:
    when: always
    reports:
      sast: gl-sast-report.json
    paths:
      - gl-sast-report.json
  allow_failure: true     # let pipeline continue even if issues are found

# --- Secret Detection ---
secret_detection:
  stage: secret-detection
  image:
    name: registry.gitlab.com/gitlab-org/security-products/analyzers/secret-detection:latest
    entrypoint: [""]
  script:
    - /analyzer run
  artifacts:
    when: always
    reports:
      secret_detection: gl-secret-detection-report.json
    paths:
      - gl-secret-detection-report.json
  allow_failure: false    # fail the pipeline if secrets are found
